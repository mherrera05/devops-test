- hosts: all
  become: yes

  pre_tasks:
    - name: Update apt cache if needed.
      apt: update_cache=yes cache_valid_time=3600

  tasks:
    - name: Download GitLab repository installation script.
      get_url:
        url: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh
        dest: /tmp/gitlab-ce.deb.sh

    - name: (GITLAB-CE) Execute GitLab-CE Deb script
      command: /bin/bash /tmp/gitlab-ce.deb.sh

    - name: (GITLAB-CE) Install GitLab Community Edition
      package:
        name: gitlab-ce
        state: latest

    - name: (GITLAB-CE) Configure GitLab Community Edition
      command: gitlab-ctl reconfigure
    # - name: Get sh
    #   shell: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | bash

    # - name: Install gitlab
    #   apt:
    #     name: gitlab-ee
    #     state: present
    #     environment:
    #       EXTERNAL_URL: http://gitlab.example.com
    #   become: yes

